# CostPerDemo Architecture

This document provides a visual representation of the CostPerDemo application architecture, showing the relationships between components, data flow, and request handling.

## System Architecture

```
                  ┌───────────────────────────┐
                  │     Client Browser        │
                  └───────────────┬───────────┘
                                  │
                                  ▼
                  ┌───────────────────────────┐
                  │  Next.js App (Vercel)     │
                  │                           │
┌─────────────────┤  ┌─────────┐ ┌─────────┐ │
│                 │  │ Pages   │ │API Routes│ │
│   ┌─────────────┤  └────┬────┘ └────┬────┘ │
│   │             │       │           │      │
│   │             └───────┼───────────┼──────┘
│   │                     │           │
│   │                     ▼           ▼
│   │             ┌──────────────────────────┐
│   │             │   Supabase Platform      │
│   │             │                          │
│   │             │  ┌─────────┐ ┌─────────┐ │
│   │             │  │Auth API │ │Postgres │ │
│   │             │  └─────────┘ └─────────┘ │
│   │             └──────────────────────────┘
│   │
│   │             ┌──────────────────────────┐
│   └────────────►│  Server-Side Rendering   │
│                 │  & Static Generation      │
│                 └──────────────────────────┘
│
│                 ┌──────────────────────────┐
└────────────────►│  Client-Side Components  │
                  │  & Interactive Features   │
                  └──────────────────────────┘
```

## Authentication Flow

```
┌──────────┐     ┌────────────┐     ┌───────────┐     ┌───────────┐
│  Browser  │────►│  /auth page│────►│  API Route│────►│  Supabase │
└────┬─────┘     └─────┬──────┘     └─────┬─────┘     └─────┬─────┘
     │                 │                  │                 │
     │  Submit login   │                  │                 │
     │─────────────────►                  │                 │
     │                 │    POST /api/auth/login           │
     │                 │─────────────────►│                 │
     │                 │                  │  Auth request   │
     │                 │                  │────────────────►│
     │                 │                  │                 │
     │                 │                  │  Auth response  │
     │                 │                  │◄────────────────│
     │                 │   Auth result    │                 │
     │                 │◄─────────────────│                 │
     │                 │                  │                 │
     │ Redirect based  │                  │                 │
     │ on user role    │                  │                 │
     │◄────────────────│                  │                 │
     │                 │                  │                 │
```

## Component Hierarchy

```
┌────────────────────────────────────────────────────┐
│ RootLayout (layout.tsx)                            │
│ ┌────────────────────────────────────────────────┐ │
│ │ ThemeProvider                                  │ │
│ │ ┌────────────────┐  ┌────────────────────────┐ │ │
│ │ │ /auth          │  │ /dashboard             │ │ │
│ │ │                │  │                        │ │ │
│ │ │ ┌────────────┐ │  │ ┌──────────────────┐  │ │ │
│ │ │ │ AuthForm   │ │  │ │DashboardContent  │  │ │ │
│ │ │ └────────────┘ │  │ └──────────────────┘  │ │ │
│ │ │                │  │                        │ │ │
│ │ └────────────────┘  └────────────────────────┘ │ │
│ │                                                │ │
│ │ ┌────────────────┐  ┌────────────────────────┐ │ │
│ │ │ /admin         │  │ /workspace             │ │ │
│ │ │                │  │                        │ │ │
│ │ │ ┌────────────┐ │  │ ┌──────────────────┐  │ │ │
│ │ │ │ AdminPanel │ │  │ │ WorkspaceForm    │  │ │ │
│ │ │ └────────────┘ │  │ └──────────────────┘  │ │ │
│ │ │                │  │                        │ │ │
│ │ └────────────────┘  └────────────────────────┘ │ │
│ │                                                │ │
│ │ ┌────────────────┐                             │ │
│ │ │ /verify        │                             │ │
│ │ │                │                             │ │
│ │ │ ┌────────────┐ │                             │ │
│ │ │ │VerifyClient│ │                             │ │
│ │ │ └────────────┘ │                             │ │
│ │ │                │                             │ │
│ │ └────────────────┘                             │ │
│ └────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────┘
```

## Data Flow

```
┌──────────┐    ┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│ UI       │    │  Next.js    │    │   API        │    │  Supabase   │
│ Components│───►│  App Router │───►│   Routes     │───►│  Services   │
└──────────┘    └─────────────┘    └──────────────┘    └─────────────┘
      │                                    │                  │
      │                                    │                  │
      │                                    │                  │
      │                                    │                  │
      ▼                                    ▼                  ▼
┌──────────┐    ┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│ User     │    │  Route      │    │  Resource    │    │   Data      │
│ Actions  │◄───│  Controls   │◄───│  Responses   │◄───│   Storage   │
└──────────┘    └─────────────┘    └──────────────┘    └─────────────┘
```

## Request-Response Cycle

```
                       ┌─────────────────────┐
                       │      Browser        │
                       └─────────┬───────────┘
                                 │
                                 │ HTTP Request
                                 ▼
┌───────────────────────────────────────────────────────────┐
│                      Next.js Server                        │
│                                                           │
│  ┌─────────────┐  ┌────────────────┐  ┌────────────────┐  │
│  │ Middleware  │─►│  App Router    │─►│  API Routes    │  │
│  └─────────────┘  └────────────────┘  └────────┬───────┘  │
│         │                  │                   │          │
│         │                  │                   │          │
│         ▼                  ▼                   ▼          │
│  ┌─────────────┐  ┌────────────────┐  ┌────────────────┐  │
│  │ Auth Check  │  │ Page Component │  │ Route Handler  │  │
│  └─────────────┘  └────────────────┘  └────────┬───────┘  │
│                                                │          │
└───────────────────────────────────────────────┼──────────┘
                                                │
                                                │ API Request
                                                ▼
                                     ┌─────────────────────┐
                                     │ Supabase Platform   │
                                     │                     │
                                     │  ┌───────────────┐  │
                                     │  │  Auth API     │  │
                                     │  └───────────────┘  │
                                     │                     │
                                     │  ┌───────────────┐  │
                                     │  │  PostgreSQL   │  │
                                     │  └───────────────┘  │
                                     │                     │
                                     └─────────────────────┘
```

## Middleware Process

```
┌────────────────┐    ┌───────────────┐    ┌───────────────┐
│ Request Starts │───►│ Middleware.ts │───►│ updateSession │
└────────────────┘    └───────┬───────┘    └───────┬───────┘
                              │                    │
                              ▼                    ▼
┌────────────────┐    ┌───────────────┐    ┌───────────────┐
│ Route-specific │◄───│ Check if API  │◄───│ Supabase Auth │
│ Logic          │    │ or Public     │    │ getUser()     │
└────────┬───────┘    └───────────────┘    └───────────────┘
         │
         ▼
┌────────────────┐    ┌───────────────┐    ┌───────────────┐
│ Check User     │───►│ Check User    │───►│ Redirect or   │
│ Authentication │    │ Role & Access │    │ Allow         │
└────────────────┘    └───────────────┘    └───────────────┘
```

## Theme Switching

```
┌───────────────────────────────────────────────────────────┐
│                     RootLayout                             │
│                                                           │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                  ThemeProvider                      │  │
│  │                                                     │  │
│  │  ┌─────────────┐       ┌─────────────────────────┐  │  │
│  │  │ useTheme()  │◄──────┤ localStorage / cookies  │  │  │
│  │  └──────┬──────┘       └─────────────────────────┘  │  │
│  │         │                                           │  │
│  │         ▼                                           │  │
│  │  ┌─────────────┐       ┌─────────────────────────┐  │  │
│  │  │ ModeToggle  │──────►│ "class" applied to html │  │  │
│  │  └─────────────┘       └─────────────────────────┘  │  │
│  │                                                     │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

## Database Schema

```
┌──────────────────────────┐       ┌──────────────────────────┐
│        users             │       │       workspaces         │
├──────────────────────────┤       ├──────────────────────────┤
│ id: uuid (PK)            │       │ id: uuid (PK)            │
│ email: text              │       │ name: text               │
│ role: text               │───┐   │ owner_id: uuid (FK)      │
│ workspace_id: uuid (FK)  │◄──┼───│ subdomain: text          │
│ created_at: timestamp    │   │   │ created_at: timestamp    │
│ updated_at: timestamp    │   │   │ updated_at: timestamp    │
└──────────────────────────┘   │   └──────────────────────────┘
                               │
                               │
                               │   ┌──────────────────────────┐
                               │   │       auth.users         │
                               │   ├──────────────────────────┤
                               └──►│ id: uuid (PK)            │
                                   │ email: text              │
                                   │ ...                      │
                                   └──────────────────────────┘
```

## Development Workflow

```
┌───────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐
│ Local Dev │────►│   Test    │────►│   Build   │────►│  Deploy   │
└─────┬─────┘     └─────┬─────┘     └─────┬─────┘     └─────┬─────┘
      │                 │                 │                 │
      ▼                 ▼                 ▼                 ▼
┌───────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐
│ npm run   │     │ Test API  │     │ npm run   │     │ GitHub    │
│ dev       │     │ endpoints │     │ build     │     │ push main │
└───────────┘     └───────────┘     └───────────┘     └───────────┘
```

This architecture document will be updated as the application evolves. 